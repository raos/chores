# CLAUDE.md

## What this project is

A household chores management app for kids. Built with Python + Streamlit + SQLite. Two roles: Parent (PIN-protected) and Child. Parent adds/approves chores; children mark them done and earn allowance.

## How to run

```bash
streamlit run app.py
```

Default parent PIN: `1234`. The SQLite database `chores.db` is created automatically on first run and is gitignored.

To use a different DB path: `CHORES_DB_PATH=/path/to/file.db streamlit run app.py`

## Python version

Python 3.9 is installed. Use `from __future__ import annotations` at the top of any file that uses `X | None` union type hint syntax (not supported natively until 3.10).

## Architecture

Three layers with strict one-way dependencies:

```
ui/  →  logic/  →  db/queries/  →  db/connection.py
```

- **`db/`** — pure data access. No Streamlit, no business logic. All queries use `get_connection()` context manager which auto-commits/rolls back.
- **`logic/`** — business logic. No Streamlit. Calls `db/queries/` modules.
- **`ui/`** — Streamlit rendering only. Calls `logic/` (never `db/` directly).
- **`app.py`** — entry point. Initialises DB, runs per-session bootstrap, routes to parent/child UI.

## Key conventions

### Database
- All queries use the `get_connection()` context manager from `db/connection.py`. Never call `sqlite3.connect()` directly elsewhere.
- `sqlite3.Row` objects are returned from all queries — access columns by name (`row["title"]`), not index.
- The `chore_instances` table has a `UNIQUE(chore_id, scheduled_date)` constraint. All instance inserts use `INSERT OR IGNORE` — idempotent by design.
- `wallet_transactions` is an append-only ledger. Balances are always computed via `SUM()`, never stored as mutable state. The `UNIQUE(chore_instance_id, transaction_type)` constraint prevents double-crediting.
- Soft-delete chores by setting `is_active = 0`. Never hard-delete chore templates.

### Streamlit session state
These keys are owned by specific modules — don't write them from anywhere else:

| Key | Owner | Meaning |
|-----|-------|---------|
| `role` | `ui/auth_gate.py` | `"parent"`, `"child"`, or `None` |
| `child_id` | `ui/auth_gate.py` | Selected child's DB id |
| `pin_verified` | `ui/auth_gate.py` | Whether parent PIN was accepted |
| `_bootstrapped` | `app.py` | Prevents re-running DB init/sweep on every rerun |
| `chore_edit_id` | `ui/parent/chore_manager.py` | `-1` = add form open, `N` = edit form for chore N |
| `chore_form_assign_to` | `ui/parent/chore_manager.py` | Must be cleared (`.pop()`) whenever the add/edit form is opened, so `index` sets the correct default |
| `calendar_view` | `ui/child/calendar.py` | `"week"` or `"day"` |
| `calendar_week_offset` | `ui/child/calendar.py` | Weeks relative to current week |
| `calendar_selected_date` | `ui/child/calendar.py` | ISO-8601 date string for day view |

### Streamlit forms and selectboxes
Streamlit `st.selectbox` uses its label as the session state key when no explicit `key=` is given. If a form is re-opened after a previous interaction, stale session state overrides the `index=` parameter on submit. **Always pass `key=` explicitly on selectboxes that need a reliable default**, and clear that key from session state when opening the form fresh.

### Recurrence
- Chore templates store recurrence rules. Instances are generated by `logic/recurrence.py:ensure_instances_for_window()`.
- `recurrence_days` column is a JSON array of weekday integers (0 = Monday, 6 = Sunday).
- Instance generation is always safe to re-run (idempotent via `INSERT OR IGNORE`).
- `app.py` generates instances for `today - 14d` through `today + 30d` on every cold session start.
- After creating or editing a chore template, call `ensure_instances_for_window(today, today + 30d)` so instances appear immediately.

### Allowance
- **Fixed** monetary: credited immediately when parent approves (`logic/wallet.py:approve_by_parent`).
- **Weighted** monetary: deferred until parent clicks "Finalize Week" (`logic/allowance.py:finalize_week`). Formula: `(chore_weight / sum_of_all_weights_that_week) * child.weekly_allowance_budget`.
- **Screen time**: always credited immediately, stored in the same `wallet_transactions` table with `transaction_type = 'screen_time'`. The DB column is named `screen_time_hours` but values are stored in **minutes** (renamed in the UI, not the schema).
- All crediting is idempotent — safe to call multiple times due to `UNIQUE(chore_instance_id, transaction_type)` on `wallet_transactions`.

### Chore status flow
```
pending → completed_pending_approval → approved
   ↑               ↓ (reset)
   └───────────────┘
```
Missed: any instance with `scheduled_date < today` and `status IN ('pending', 'completed_pending_approval')` is swept to `missed` at session start.

Status transitions use `UPDATE ... WHERE id=? AND status=?` — check `rowcount == 1` to detect races or double-clicks.

## Adding new UI features

- Parent features go in `ui/parent/`. Child features go in `ui/child/`.
- New DB queries go in the appropriate `db/queries/` module.
- New business logic goes in `logic/`. Keep it free of Streamlit imports.
- Wire new parent tabs in `app.py:_render_parent_app()`. Wire new child tabs in `app.py:_render_child_app()`.

## Do not

- Import Streamlit in `db/` or `logic/` modules.
- Call `sqlite3.connect()` outside `db/connection.py`.
- Write to `role`, `child_id`, or `pin_verified` session state keys outside `ui/auth_gate.py`.
- Hard-delete chore templates — use `deactivate_chore()` (sets `is_active = 0`) instead.
- Store wallet balances as mutable state — always derive them with `SUM()` from `wallet_transactions`.
- Commit to git unless explicitly asked.
